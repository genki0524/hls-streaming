<!DOCTYPE html>
<html>
<head>
    <title>HLS Player</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug { margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .play-btn { background: #4CAF50; color: white; }
        .reload-btn { background: #2196F3; color: white; }
    </style>
</head>
<body>
    <h1>HLS Streaming Player</h1>
    
    <video id="videoPlayer" width="800" height="450" controls></video>
    
    <div>
        <button class="play-btn" onclick="playVideo()">å†ç”Ÿ</button>
        <button class="reload-btn" onclick="reloadStream()">ã‚¹ãƒˆãƒªãƒ¼ãƒ å†èª­ã¿è¾¼ã¿</button>
        <button onclick="testM3u8()">M3U8ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testTSFile()">TSãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆ</button>
    </div>
    
    <div class="debug">
        <h3>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
        <div id="debug-info"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const video = document.getElementById('videoPlayer');
        const debugInfo = document.getElementById('debug-info');
        const streamUrl = 'http://localhost:8000/live/video.m3u8';
        let hls;

        function log(message) {
            console.log(message);
            debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        function setupPlayer() {
            log('ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...');
            
            if (Hls.isSupported()) {
                log('âœ“ HLS.js ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™');
                hls = new Hls({
                    debug: false,
                    enableWorker: false
                });
                
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    log(`âœ“ HLSãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆè§£æå®Œäº† - ãƒ¬ãƒ™ãƒ«æ•°: ${data.levels.length}`);
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    log(`âŒ HLSã‚¨ãƒ©ãƒ¼: ${data.type} - ${data.details}`);
                    if (data.response) {
                        log(`ğŸ“„ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°: ${JSON.stringify(data.response)}`);
                    }
                    if (data.url) {
                        log(`ğŸ”— ã‚¨ãƒ©ãƒ¼URL: ${data.url}`);
                    }
                    if (data.fatal) {
                        log('âš ï¸ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                log('ğŸ”„ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ - å†è©¦è¡Œä¸­...');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                log('ğŸ”„ ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¨ãƒ©ãƒ¼ - å¾©æ—§ä¸­...');
                                hls.recoverMediaError();
                                break;
                            default:
                                log('âŒ å¾©æ—§ä¸å¯èƒ½ãªã‚¨ãƒ©ãƒ¼');
                                break;
                        }
                    }
                });
                
                hls.on(Hls.Events.FRAG_LOADED, function(event, data) {
                    log(`âœ“ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†: ${data.frag.url}`);
                });
                
                hls.on(Hls.Events.FRAG_LOADING, function(event, data) {
                    log(`ğŸ”„ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ä¸­: ${data.frag.url}`);
                });
                
                hls.on(Hls.Events.LEVEL_LOADED, function(event, data) {
                    log(`âœ“ ãƒ¬ãƒ™ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${data.details.fragments.length} ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ`);
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                log('âœ“ ãƒã‚¤ãƒ†ã‚£ãƒ–HLSã‚µãƒãƒ¼ãƒˆã‚’ä½¿ç”¨');
                video.src = streamUrl;
            } else {
                log('âŒ HLSãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        }

        function playVideo() {
            log('å†ç”Ÿãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            
            video.play().then(() => {
                log('âœ“ å‹•ç”»å†ç”Ÿé–‹å§‹');
            }).catch(error => {
                log(`âŒ å†ç”Ÿå¤±æ•—: ${error.message}`);
                
                // éŸ³å£°ãªã—ã§å†è©¦è¡Œ
                video.muted = true;
                return video.play();
            }).then(() => {
                if (video.muted) {
                    log('âœ“ ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã§å†ç”Ÿé–‹å§‹');
                }
            }).catch(error => {
                log(`âŒ ãƒŸãƒ¥ãƒ¼ãƒˆå†ç”Ÿã‚‚å¤±æ•—: ${error.message}`);
            });
        }

        function reloadStream() {
            log('ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å†èª­ã¿è¾¼ã¿ä¸­...');
            if (hls) {
                hls.destroy();
            }
            setupPlayer();
        }

        async function testM3u8() {
            log('M3U8ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆä¸­...');
            try {
                const response = await fetch(streamUrl);
                const text = await response.text();
                log(`âœ“ M3U8ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (${response.status}):`);
                log(`ğŸ“ å†…å®¹: ${text}`);
                
                // m3u8ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
                const lines = text.split('\n');
                if (!lines[0].includes('#EXTM3U')) {
                    log('âŒ m3u8ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸æ­£ã§ã™');
                }
                if (!text.includes('#EXT-X-VERSION')) {
                    log('âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ãŒä¸æ­£ã§ã™');
                }
                log('âœ“ m3u8åŸºæœ¬æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†');
                
            } catch (error) {
                log(`âŒ M3U8å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function testTSFile() {
            log('TSãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆä¸­...');
            try {
                // ã¾ãšm3u8ã‚’å–å¾—ã—ã¦TSãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’å–å¾—
                const m3u8Response = await fetch(streamUrl);
                const m3u8Text = await m3u8Response.text();
                
                // æœ€åˆã®TSãƒ•ã‚¡ã‚¤ãƒ«ã®URLã‚’æŠ½å‡º
                const lines = m3u8Text.split('\n');
                const tsLine = lines.find(line => line.endsWith('.ts'));
                
                if (tsLine) {
                    const tsUrl = `http://localhost:8000${tsLine}`;
                    log(`ğŸ“¹ TSãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆ: ${tsUrl}`);
                    
                    const tsResponse = await fetch(tsUrl, { method: 'HEAD' });
                    log(`âœ“ TSãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ (${tsResponse.status})`);
                    log(`ğŸ“Š Content-Type: ${tsResponse.headers.get('content-type')}`);
                    log(`ğŸ“ Content-Length: ${tsResponse.headers.get('content-length')}`);
                } else {
                    log('âŒ m3u8ã‹ã‚‰TSãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                log(`âŒ TSãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // åˆæœŸåŒ–
        setupPlayer();
    </script>
</body>
</html>